'use client';
import React, { useState } from 'react';
import ImageEditor from './ImageEditor';

type NewsItem = { title?: string; description?: string; source?: string; url?: string; image?: string; };

export default function GeneratePreview({ selected }: { selected?: NewsItem }) {
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState<string|undefined>();
  const [url, setUrl] = useState<string|undefined>();
  const [used, setUsed] = useState<string|undefined>();  // "seedream" | "fallback"
  const [reason, setReason] = useState<string|undefined>();
  const [editorOpen, setEditorOpen] = useState(false);

  async function generate() {
    try{
      setBusy(true); setError(undefined);
      const res = await fetch('/api/gen/image', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          prompt: 'Visuel social moderne, lisible. Mettre en avant le message clé.',
          selected
        })
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(t||`HTTP ${res.status}`);
      }
      const json = await res.json();
      setUrl(json.imageDataUrl);
      setUsed(json.used);
      setReason(json.reason);
    }catch(e:any){
      setError(e?.message||String(e));
    }finally{
      setBusy(false);
    }
  }

  return (
    <div className="rounded-2xl border border-neutral-200 p-4 bg-white">
      <div className="flex items-center justify-between mb-3">
        <h4 className="font-medium">Génération basée sur l’actualité</h4>
      </div>
      {error && <div className="text-sm text-red-600 mb-3">Erreur: {error}</div>}

      <button onClick={generate}
        className="w-full rounded-md bg-black text-white py-2 mb-3 disabled:opacity-60"
        disabled={busy || !selected}>
        {busy? "Génération…" : "Générer l’image à partir de l’actu sélectionnée"}
      </button>

      {used && <div className="text-xs text-neutral-500 mb-2">
        Service: {used}{reason? ` (${reason})` : ""}
      </div>}

      {url && (
        <>
          <img src={url} alt="Aperçu généré" className="w-full h-[220px] object-cover rounded-md border border-neutral-200 bg-neutral-100 mb-3"/>
          <button
            className="w-full rounded-md border border-neutral-300 py-2 hover:bg-neutral-50"
            onClick={()=>setEditorOpen(true)}
          >
            Éditer dans Keiro
          </button>
        </>
      )}

      {editorOpen && url && (
        <ImageEditor
          image={url}
          onClose={()=>setEditorOpen(false)}
          onUpdated={(newUrl)=>setUrl(newUrl)}
        />
      )}
    </div>
  );
}
