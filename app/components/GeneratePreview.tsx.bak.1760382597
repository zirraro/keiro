'use client';
import React from 'react';

type SelectedNews = { title?: string; description?: string; source?: string; url?: string; image?: string; };

export default function GeneratePreview({ selected }:{ selected?: SelectedNews }){
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState<string|undefined>();
  const [imageUrl, setImageUrl] = React.useState<string|undefined>();

  const basePrompt = React.useMemo(()=>{
    let p = 'Affiche marketing élégante, format 1:1, style minimal, lisible, accroche forte.';
    if (selected?.title) p += ` Sujet: ${selected.title}.`;
    if (selected?.description) p += ` Contexte: ${selected.description}.`;
    return p;
  }, [selected]);

  const doGenerate = async ()=>{
    setError(undefined); setLoading(true);
    try{
      const res = await fetch('/api/ark/generate
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({
          prompt: basePrompt,
          size: '1024x1024',
          extras: {}
        })
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j?.error || j?.message || `HTTP ${res.status}`);
      const url = j?.url as string;
      if (!url) throw new Error('no image url from api');
      // Passe par le proxy pour affichage fiable
      const proxied = url.startsWith('data:') ? url : `/api/img?u=${encodeURIComponent(url)}`;
      setImageUrl(proxied);
    }catch(e:any){
      setError(e?.message || 'fetch failed');
    }finally{
      setLoading(false);
    }
  };

  const doEdit = async ()=>{
    if (!imageUrl) { setError('Génère d’abord une image.'); return; }
    setError(undefined); setLoading(true);
    try{
      // On envoie l’URL d’origine si possible (si proxied, enlève /api/img?u=…)
      const src = imageUrl.startsWith('/api/img?u=') ? decodeURIComponent(imageUrl.split('=')[1]) : imageUrl;
      const res = await fetch('/api/ark/generate
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({
          source: src,
          edits: {
            // exemples d’édition simples — à adapter selon Seedream (texte, clean bg, upscaling…)
            instruction: 'Renforcer le contraste, améliorer la netteté, équilibrer les couleurs'
          }
        })
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j?.error || j?.message || `HTTP ${res.status}`);
      const url = j?.url as string;
      if (!url) throw new Error('no image url from api');
      const proxied = url.startsWith('data:') ? url : `/api/img?u=${encodeURIComponent(url)}`;
      setImageUrl(proxied);
    }catch(e:any){
      setError(e?.message || 'fetch failed');
    }finally{
      setLoading(false);
    }
  };

  return (
    <div className="rounded-2xl border border-neutral-200 p-4 bg-white">
      <div className="flex items-center justify-between mb-3">
        <h4 className="font-medium">Génération & édition Seedream</h4>
      </div>

      {selected?.title && (
        <div className="text-xs text-neutral-500 mb-2">
          Basé sur: <span className="font-medium">{selected.title}</span>
        </div>
      )}

      <div className="flex gap-2 mb-3">
        <button
          className="px-3 py-1.5 rounded-md bg-black text-white disabled:opacity-50"
          onClick={doGenerate}
          disabled={loading}
        >
          {loading ? 'Génération…' : 'Générer l’image'}
        </button>
        <button
          className="px-3 py-1.5 rounded-md border border-neutral-300 hover:bg-neutral-50 disabled:opacity-50"
          onClick={doEdit}
          disabled={loading}
        >
          {loading ? 'Édition…' : 'Éditer (Seedream)'}
        </button>
      </div>

      {error && <div className="text-sm text-red-600 mb-2">Erreur : {error}</div>}

      {imageUrl && (
        <div className="w-full border rounded-lg p-2 bg-neutral-50">
          <img src={imageUrl} alt="aperçu" className="w-full h-[320px] object-cover rounded-md" />
          <div className="text-xs text-neutral-500 mt-1 truncate">{imageUrl}</div>
          <div className="mt-2">
            <a
              href={`/editor?src=${encodeURIComponent(imageUrl)}`}
              className="inline-block px-3 py-1.5 rounded-md bg-neutral-900 text-white hover:opacity-90"
            >Ouvrir dans l’éditeur</a>
          </div>
        </div>
      )}
    </div>
  );
}
