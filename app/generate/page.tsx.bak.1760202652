'use client';

import React, {useEffect, useMemo, useState} from 'react';

type NewsItem = {
  id?: string;
  title: string;
  description?: string;
  url: string;
  image?: string;
  source?: string;
  publishedAt?: string;
};

const cls = (...a: (string | false | undefined)[]) => a.filter(Boolean).join(' ');

/**
 * Catégories visibles (FR) -> slugs backend attendus par /api/news/search
 * NB: "Hooks viraux" est mappé provisoirement sur technology (en attendant une vraie cat côté API).
 */
const CATEGORIES: { label: string; slug: string }[] = [
  { label: 'Hooks viraux', slug: 'technology' }, // TODO: remapper vers "hooks" quand l'API le supporte
  { label: 'IA',          slug: 'technology' },
  { label: 'Business',    slug: 'business' },
  { label: 'Finance',     slug: 'finance' },
  { label: 'Sports',      slug: 'sports' },
  { label: 'Gaming',      slug: 'gaming' },
  { label: 'Culture',     slug: 'culture' },
  { label: 'Food',        slug: 'food' },
  { label: 'Lifestyle',   slug: 'lifestyle' },
  { label: 'Sante',       slug: 'sante' },
  { label: 'Auto',        slug: 'auto' },
  { label: 'Climat',      slug: 'climat' },
  { label: 'Immo',        slug: 'immo' },
  { label: 'Monde',       slug: 'world' },
];

const PERIODS: { label: string; value: '24h' | '7d' }[] = [
  { label: 'Dernières 24h', value: '24h' },
  { label: 'Derniers 7 jours', value: '7d' },
];

export default function GeneratePage() {
  // Filtres (gauche)
  const [categorySlug, setCategorySlug] = useState<string>('technology'); // défaut: IA
  const [period, setPeriod] = useState<'24h' | '7d'>('24h');
  const [limit, setLimit] = useState<number>(12);

  // Données news
  const [items, setItems] = useState<NewsItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [errMsg, setErrMsg] = useState<string | null>(null);

  // Sélection (pour l’assistant de prompt à droite)
  const [selected, setSelected] = useState<NewsItem | null>(null);

  // Assistant: champs prompt (droite)
  const [brand, setBrand] = useState('');
  const [goal, setGoal] = useState('notoriété');
  const [tone, setTone] = useState('moderne');
  const [constraints, setConstraints] = useState('couleurs brand');
  const [cta, setCta] = useState('Découvrir');
  const [hashtags, setHashtags] = useState('#AI #Keiro');

  // Résultat de génération image (quick test)
  const [genUrl, setGenUrl] = useState<string | null>(null);
  const [genErr, setGenErr] = useState<string | null>(null);
  const [busyGen, setBusyGen] = useState(false);

  // Charge les news à chaque changement de filtre
  useEffect(() => {
    setLoading(true);
    setErrMsg(null);
    fetch(`/api/news/search?cat=${encodeURIComponent(categorySlug)}&timeframe=${period}&limit=${limit}`)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then((j) => {
        const arr = Array.isArray(j?.items) ? j.items : [];
        setItems(arr);
        // Réinitialise la sélection si l’article choisi ne fait plus partie de la liste
        if (selected && !arr.find((x: NewsItem) => x.url === selected.url)) {
          setSelected(null);
        }
      })
      .catch(e => setErrMsg(String(e?.message || e)))
      .finally(() => setLoading(false));
  }, [categorySlug, period, limit]);

  // Aperçu “source” pour la colonne de droite
  const selectedLine = useMemo(() => {
    if (!selected) return '';
    const when = selected.publishedAt ? new Date(selected.publishedAt).toLocaleString() : '';
    const src = selected.source ? ` • ${selected.source}` : '';
    return `${selected.title}${src}${when ? ' — ' + when : ''}`;
  }, [selected]);

  async function generateImage() {
    setBusyGen(true);
    setGenErr(null);
    setGenUrl(null);
    try {
      const payload: any = {
        brand: brand || 'Ma Marque',
        tone,
        cta,
      };
      if (selected) payload.newsTitle = selected.title;
      const r = await fetch('/api/generate/image', {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify(payload),
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`);
      if (j?.kind === 'image' && typeof j?.url === 'string') {
        setGenUrl(j.url);
      } else if (j?.kind === 'error') {
        throw new Error(`${j.code||'ERROR'}: ${j.message||'upstream'}`);
      } else {
        throw new Error('Réponse inattendue du service image');
      }
    } catch(e:any) {
      setGenErr(String(e?.message||e));
    } finally {
      setBusyGen(false);
    }
  }

  return (
    <main className="mx-auto max-w-7xl px-4 py-6">
      {/* Fil d’ariane */}
      <div className="flex items-center justify-between mb-4">
        <div className="text-sm text-neutral-500">
          KeiroAI — Actu → Cartes → Génération
        </div>
      </div>

      {/* 2 colonnes : liste (gauche) + assistant (droite) */}
      <div className="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-6">
        {/* COLONNE GAUCHE */}
        <section>
          {/* Barre de filtres */}
          <div className="flex flex-wrap items-center gap-3 mb-4">
            {/* Catégorie */}
            <label className="text-sm">
              <span className="mr-2 text-neutral-600">Catégorie</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={categorySlug}
                onChange={(e)=>setCategorySlug(e.target.value)}
              >
                {CATEGORIES.map(c => (
                  <option key={c.slug} value={c.slug}>{c.label}</option>
                ))}
              </select>
            </label>

            {/* Période */}
            <label className="text-sm">
              <span className="mr-2 text-neutral-600">Période</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={period}
                onChange={(e)=>setPeriod(e.target.value as '24h'|'7d')}
              >
                {PERIODS.map(p => (
                  <option key={p.value} value={p.value}>{p.label}</option>
                ))}
              </select>
            </label>

            {/* Limite */}
            <label className="text-sm">
              <span className="mr-2 text-neutral-600"># cartes</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={String(limit)}
                onChange={(e)=>setLimit(parseInt(e.target.value,10))}
              >
                {[6,8,10,12].map(n => (<option key={n} value={n}>{n}</option>))}
              </select>
            </label>
          </div>

          {/* État de chargement / erreur */}
          {loading && <div className="text-sm text-neutral-500 mb-2">Chargement…</div>}
          {errMsg && <div className="text-sm text-red-600 mb-2">Erreur: {errMsg}</div>}
          {!loading && items.length === 0 && (
            <div className="text-sm text-neutral-500 border border-dashed rounded-md p-3">
              Aucune actualité pertinente pour cette catégorie/période.
            </div>
          )}

          {/* Grille d’articles */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {items.slice(0, limit).map((it, i) => (
              <article
                key={it.url || i}
                className={cls(
                  "rounded-xl border border-neutral-200 bg-white overflow-hidden transition",
                  selected?.url === it.url ? "ring-2 ring-black" : "hover:shadow-md"
                )}
              >
                {it.image && (
                  <a href={it.url} target="_blank" rel="noreferrer">
                    <img
                      src={it.image}
                      alt={it.title}
                      className="w-full h-[160px] object-cover"
                      loading="lazy"
                    />
                  </a>
                )}
                <div className="p-3">
                  <div className="text-xs text-neutral-500 mb-1">
                    {it.source || '—'} {it.publishedAt ? `• ${new Date(it.publishedAt).toLocaleString()}` : ''}
                  </div>
                  <h3 className="font-medium leading-snug mb-1 line-clamp-2">{it.title}</h3>
                  {it.description && (
                    <p className="text-sm text-neutral-600 line-clamp-3 mb-3">{it.description}</p>
                  )}
                  <div className="flex items-center gap-2">
                    <a
                      href={it.url}
                      target="_blank"
                      rel="noreferrer"
                      className="px-3 py-1.5 rounded-md border border-neutral-300 text-sm hover:bg-neutral-50"
                    >
                      Voir la source
                    </a>
                    <button
                      onClick={()=>setSelected(it)}
                      className={cls(
                        "px-3 py-1.5 rounded-md text-sm",
                        selected?.url === it.url ? "bg-black text-white" : "bg-neutral-900 text-white hover:opacity-90"
                      )}
                    >
                      Utiliser cette actu
                    </button>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </section>

        {/* COLONNE DROITE */}
        <aside className="lg:sticky lg:top-20 h-fit">
          <div className="rounded-2xl border border-neutral-200 p-4 bg-white">
            <h3 className="font-semibold mb-3">Assistant de prompt</h3>

            {!selected && (
              <div className="mb-3 text-xs text-neutral-500">
                Aucune actualité sélectionnée — vous pouvez générer sans, mais la sortie sera plus générique.
              </div>
            )}
            {selected && (
              <div className="mb-3 text-xs text-neutral-500">
                Source sélectionnée : <span className="font-medium">{selectedLine}</span>
              </div>
            )}

            <div className="grid grid-cols-1 gap-3">
              <div>
                <label className="block text-xs text-neutral-600 mb-1">Marque</label>
                <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                       value={brand} onChange={e=>setBrand(e.target.value)} />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Objectif</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={goal} onChange={e=>setGoal(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Ton</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={tone} onChange={e=>setTone(e.target.value)} />
                </div>
              </div>
              <div>
                <label className="block text-xs text-neutral-600 mb-1">Contraintes</label>
                <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                       value={constraints} onChange={e=>setConstraints(e.target.value)} />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">CTA</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={cta} onChange={e=>setCta(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">#Hashtags</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={hashtags} onChange={e=>setHashtags(e.target.value)} />
                </div>
              </div>
            </div>

            <div className="mt-4 flex items-center gap-2">
              <button
                onClick={generateImage}
                disabled={busyGen}
                className={cls(
                  "px-3 py-2 rounded-md text-sm",
                  busyGen ? "bg-neutral-300 text-neutral-600" : "bg-black text-white hover:opacity-90"
                )}
              >
                {busyGen ? "Génération…" : "Générer l’image"}
              </button>
              {genUrl && (
                <a href={genUrl} target="_blank" rel="noreferrer"
                   className="text-sm underline text-neutral-700">
                  Ouvrir l’image
                </a>
              )}
            </div>
            {genErr && <div className="mt-2 text-xs text-red-600">Erreur: {genErr}</div>}
          </div>
        </aside>
      </div>
    </main>
  );
}
