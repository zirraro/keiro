'use client';

import React, { useEffect, useMemo, useState } from 'react';

type NewsItem = {
  id?: string;
  title: string;
  description?: string;
  url: string;
  image?: string;
  source?: string;
  publishedAt?: string;
};

const cls = (...a: (string | false | undefined)[]) => a.filter(Boolean).join(' ');

/** Catégories FR -> slugs backend */
const CATEGORIES: { label: string; slug: string }[] = [
  { label: 'Hooks viraux', slug: 'technology' }, // TODO: brancher "hooks" côté API si dispo
  { label: 'IA',          slug: 'technology' },
  { label: 'Business',    slug: 'business' },
  { label: 'Finance',     slug: 'finance' },
  { label: 'Sports',      slug: 'sports' },
  { label: 'Gaming',      slug: 'gaming' },
  { label: 'Culture',     slug: 'culture' },
  { label: 'Food',        slug: 'food' },
  { label: 'Lifestyle',   slug: 'lifestyle' },
  { label: 'Sante',       slug: 'sante' },
  { label: 'Auto',        slug: 'auto' },
  { label: 'Climat',      slug: 'climat' },
  { label: 'Immo',        slug: 'immo' },
  { label: 'Monde',       slug: 'world' },
];

const PERIODS: { label: string; value: '24h' | '7d' }[] = [
  { label: 'Dernières 24h', value: '24h' },
  { label: 'Derniers 7 jours', value: '7d' },
];

export default function GeneratePage() {
  /** Filtres */
  const [categorySlug, setCategorySlug] = useState<string>('technology');
  const [period, setPeriod] = useState<'24h' | '7d'>('24h');
  const [limit, setLimit] = useState<number>(12);

  /** News */
  const [items, setItems] = useState<NewsItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [errMsg, setErrMsg] = useState<string | null>(null);
  const [selected, setSelected] = useState<NewsItem | null>(null);

  /** Logo (dropzone/URL) */
  const [logoUrl, setLogoUrl] = useState('');
  const [dragOver, setDragOver] = useState(false);

  /** Assistant (détaillé) */
  const [brand, setBrand] = useState('');
  const [industry, setIndustry] = useState('');
  const [audience, setAudience] = useState('');
  const [goal, setGoal] = useState('notoriété');
  const [channels, setChannels] = useState('Instagram Reels, TikTok, LinkedIn');
  const [format, setFormat] = useState('post statique');
  const [ratio, setRatio] = useState('1:1');
  const [tone, setTone] = useState('moderne');
  const [brandColors, setBrandColors] = useState('couleurs brand');
  const [doList, setDoList] = useState('mettre le logo, CTA clair');
  const [dontList, setDontList] = useState('pas de texte trop long');
  const [references, setReferences] = useState('style Apple Keynote, minimalisme');
  const [legal, setLegal] = useState('pas de mention concurrente, pas de promesse de résultat');
  const [mood, setMood] = useState('futuriste, tech-friendly');
  const [cta, setCta] = useState('Découvrir');
  const [hashtags, setHashtags] = useState('#AI #Keiro');
  const [punch, setPunch] = useState(6);   // 1..10
  const [risk, setRisk] = useState(4);     // 1..10

  /** Génération image */
  const [busyGen, setBusyGen] = useState(false);
  const [genUrl, setGenUrl] = useState<string | null>(null);
  const [genErr, setGenErr] = useState<string | null>(null);

  /** Fetch news */
  useEffect(() => {
    setLoading(true);
    setErrMsg(null);
    fetch(`/api/news/search?cat=${encodeURIComponent(categorySlug)}&timeframe=${period}&limit=${limit}`)
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(j => {
        const arr = Array.isArray(j?.items) ? j.items : [];
        setItems(arr);
        if (selected && !arr.find((x: NewsItem) => x.url === selected.url)) {
          setSelected(null);
        }
      })
      .catch(e => setErrMsg(String(e?.message || e)))
      .finally(() => setLoading(false));
  }, [categorySlug, period, limit]);

  /** Ligne source compactée */
  const selectedLine = useMemo(() => {
    if (!selected) return '';
    const when = selected.publishedAt ? new Date(selected.publishedAt).toLocaleString() : '';
    const src = selected.source ? ` • ${selected.source}` : '';
    return `${selected.title}${src}${when ? ' — ' + when : ''}`;
  }, [selected]);

  /** Prompt composé */
  const compiledPrompt = useMemo(() => {
    const lines = [
      brand && `Marque: ${brand}`,
      industry && `Secteur: ${industry}`,
      audience && `Audience: ${audience}`,
      goal && `Objectif: ${goal}`,
      channels && `Canaux: ${channels}`,
      `Format: ${format} • Ratio: ${ratio}`,
      tone && `Ton: ${tone}`,
      brandColors && `Couleurs: ${brandColors}`,
      doList && `À faire: ${doList}`,
      dontList && `À éviter: ${dontList}`,
      references && `Références: ${references}`,
      mood && `Mood/Style: ${mood}`,
      legal && `Contraintes légales: ${legal}`,
      cta && `CTA: ${cta}`,
      hashtags && `Hashtags: ${hashtags}`,
      logoUrl && `Logo: ${logoUrl}`,
      `Niveau d’impact: ${punch}/10 • Prise de risque: ${risk}/10`,
      selected ? `Actu: ${selected.title} • Source: ${selected.source ?? '—'}` : `Actu: —`,
    ].filter(Boolean);
    return lines.join('\n');
  }, [brand, industry, audience, goal, channels, format, ratio, tone, brandColors, doList, dontList, references, mood, legal, cta, hashtags, logoUrl, punch, risk, selected]);

  /** Dropzone */
  function onDrop(e: React.DragEvent<HTMLDivElement>) {
    e.preventDefault();
    setDragOver(false);
    const file = e.dataTransfer.files?.[0];
    if (file && file.type.startsWith('image/')) {
      const url = URL.createObjectURL(file);
      setLogoUrl(url);
    }
  }

  async function generateImage() {
    setBusyGen(true);
    setGenErr(null);
    setGenUrl(null);
    try {
      const payload: any = {
        brand: brand || 'Ma Marque',
        tone,
        cta,
        // On passe aussi un contexte “newsTitle” si une actu est choisie
        ...(selected ? { newsTitle: selected.title } : {}),
        // et quelques métadonnées utiles côté moteur
        meta: {
          industry, audience, goal, channels, format, ratio, brandColors,
          doList, dontList, references, legal, mood, hashtags, punch, risk, logoUrl,
          source: selected?.source ?? null,
        },
      };
      const r = await fetch('/api/generate/image', {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify(payload),
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`);
      if (j?.kind === 'image' && typeof j?.url === 'string') {
        setGenUrl(j.url);
      } else if (j?.kind === 'error') {
        throw new Error(`${j.code||'ERROR'}: ${j.message||'upstream'}`);
      } else {
        throw new Error('Réponse inattendue du service image');
      }
    } catch (e:any) {
      setGenErr(String(e?.message || e));
    } finally {
      setBusyGen(false);
    }
  }

  return (
    <main className="mx-auto max-w-7xl px-4 py-6">
      {/* Fil d’ariane */}
      <div className="flex items-center justify-between mb-4">
        <div className="text-sm text-neutral-500">
          KeiroAI — Actu → Cartes → Génération
        </div>
      </div>

      {/* 2 colonnes : liste (gauche) + assistant (droite) */}
      <div className="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6">
        {/* COLONNE GAUCHE */}
        <section>
          {/* Filtres */}
          <div className="flex flex-wrap items-center gap-3 mb-4">
            <label className="text-sm">
              <span className="mr-2 text-neutral-600">Catégorie</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={categorySlug}
                onChange={(e)=>setCategorySlug(e.target.value)}
              >
                {CATEGORIES.map(c => (
                  <option key={c.slug} value={c.slug}>{c.label}</option>
                ))}
              </select>
            </label>
            <label className="text-sm">
              <span className="mr-2 text-neutral-600">Période</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={period}
                onChange={(e)=>setPeriod(e.target.value as '24h'|'7d')}
              >
                {PERIODS.map(p => (
                  <option key={p.value} value={p.value}>{p.label}</option>
                ))}
              </select>
            </label>
            <label className="text-sm">
              <span className="mr-2 text-neutral-600"># cartes</span>
              <select
                className="rounded-md border border-neutral-300 px-2 py-1 text-sm"
                value={String(limit)}
                onChange={(e)=>setLimit(parseInt(e.target.value,10))}
              >
                {[6,9,12,15].map(n => (<option key={n} value={n}>{n}</option>))}
              </select>
            </label>
          </div>

          {/* État */}
          {loading && <div className="text-sm text-neutral-500 mb-2">Chargement…</div>}
          {errMsg && <div className="text-sm text-red-600 mb-2">Erreur: {errMsg}</div>}
          {!loading && items.length === 0 && (
            <div className="text-sm text-neutral-500 border border-dashed rounded-md p-3">
              Aucune actualité pertinente pour cette catégorie/période.
            </div>
          )}

          {/* Grille 3 colonnes (screen 2-like) */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {items.slice(0, limit).map((it, i) => (
              <article
                key={it.url || i}
                className={cls(
                  "rounded-xl border border-neutral-200 bg-white overflow-hidden transition",
                  selected?.url === it.url ? "ring-2 ring-black" : "hover:shadow-md"
                )}
              >
                {it.image && (
                  <a href={it.url} target="_blank" rel="noreferrer">
                    <img
                      src={it.image}
                      alt={it.title}
                      className="w-full h-[150px] object-cover"
                      loading="lazy"
                    />
                  </a>
                )}
                <div className="p-3">
                  <div className="text-[11px] text-neutral-500 mb-1">
                    {it.source || '—'} {it.publishedAt ? `• ${new Date(it.publishedAt).toLocaleString()}` : ''}
                  </div>
                  <h3 className="font-medium leading-snug mb-1 line-clamp-2">{it.title}</h3>
                  {it.description && (
                    <p className="text-[13px] text-neutral-600 line-clamp-3 mb-3">{it.description}</p>
                  )}
                  <div className="flex items-center gap-2">
                    <a
                      href={it.url}
                      target="_blank"
                      rel="noreferrer"
                      className="px-2.5 py-1.5 rounded-md border border-neutral-300 text-[13px] hover:bg-neutral-50"
                    >
                      Voir la source
                    </a>
                    <button
                      onClick={()=>setSelected(it)}
                      className={cls(
                        "px-2.5 py-1.5 rounded-md text-[13px]",
                        selected?.url === it.url ? "bg-black text-white" : "bg-neutral-900 text-white hover:opacity-90"
                      )}
                    >
                      Utiliser cette actu
                    </button>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </section>

        {/* COLONNE DROITE (assistant) */}
        <aside className="lg:sticky lg:top-20 h-fit">
          <div className="rounded-2xl border border-neutral-200 p-4 bg-white">
            <h3 className="font-semibold mb-3">Assistant de prompt</h3>

            {/* Dropzone logo */}
            <div
              className={cls(
                "mb-3 rounded-md border-2 border-dashed p-3 text-center cursor-pointer",
                dragOver ? "border-black bg-neutral-50" : "border-neutral-300"
              )}
              onDragOver={(e)=>{e.preventDefault(); setDragOver(true);}}
              onDragLeave={()=>setDragOver(false)}
              onDrop={onDrop}
            >
              <div className="text-sm mb-2">Insérer un logo (glisser-déposer, ou URL ci-dessous)</div>
              {logoUrl ? (
                <div className="flex items-center justify-center">
                  <img src={logoUrl} alt="Logo" className="h-12 object-contain" />
                </div>
              ) : (
                <div className="text-xs text-neutral-500">PNG / SVG recommandé</div>
              )}
            </div>
            <input
              placeholder="URL du logo (optionnel)"
              className="w-full rounded-md border border-neutral-300 px-3 py-2 mb-3"
              value={logoUrl}
              onChange={(e)=>setLogoUrl(e.target.value)}
            />

            {/* Contexte & paramètres marketing */}
            {selected ? (
              <div className="mb-3 text-xs text-neutral-500">
                Source sélectionnée : <span className="font-medium">{selectedLine}</span>
              </div>
            ) : (
              <div className="mb-3 text-xs text-neutral-500">
                Aucune actualité sélectionnée — vous pouvez générer sans, mais la sortie sera plus générique.
              </div>
            )}

            <div className="grid grid-cols-1 gap-3">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Marque</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={brand} onChange={e=>setBrand(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Secteur</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={industry} onChange={e=>setIndustry(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Audience</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={audience} onChange={e=>setAudience(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Objectif</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={goal} onChange={e=>setGoal(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Canaux</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={channels} onChange={e=>setChannels(e.target.value)} />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs text-neutral-600 mb-1">Format</label>
                    <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                           value={format} onChange={e=>setFormat(e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-xs text-neutral-600 mb-1">Ratio</label>
                    <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                           value={ratio} onChange={e=>setRatio(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Ton</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={tone} onChange={e=>setTone(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Couleurs de marque</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={brandColors} onChange={e=>setBrandColors(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">À faire</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={doList} onChange={e=>setDoList(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">À éviter</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={dontList} onChange={e=>setDontList(e.target.value)} />
                </div>
              </div>

              <div>
                <label className="block text-xs text-neutral-600 mb-1">Références / Moodboard</label>
                <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                       value={references} onChange={e=>setReferences(e.target.value)} />
              </div>

              <div>
                <label className="block text-xs text-neutral-600 mb-1">Contraintes légales</label>
                <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                       value={legal} onChange={e=>setLegal(e.target.value)} />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">CTA</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={cta} onChange={e=>setCta(e.target.value)} />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">#Hashtags</label>
                  <input className="w-full rounded-md border border-neutral-300 px-3 py-2"
                         value={hashtags} onChange={e=>setHashtags(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Impact / Punch ({punch}/10)</label>
                  <input type="range" min={1} max={10} value={punch}
                         onChange={e=>setPunch(parseInt(e.target.value,10))}
                         className="w-full" />
                </div>
                <div>
                  <label className="block text-xs text-neutral-600 mb-1">Prise de risque ({risk}/10)</label>
                  <input type="range" min={1} max={10} value={risk}
                         onChange={e=>setRisk(parseInt(e.target.value,10))}
                         className="w-full" />
                </div>
              </div>

              {/* Actions */}
              <div className="mt-1 flex items-center gap-2">
                <button
                  onClick={generateImage}
                  disabled={busyGen}
                  className={cls(
                    "px-3 py-2 rounded-md text-sm",
                    busyGen ? "bg-neutral-300 text-neutral-600" : "bg-black text-white hover:opacity-90"
                  )}
                >
                  {busyGen ? "Génération…" : "Générer l’image"}
                </button>
                {genUrl && (
                  <a href={genUrl} target="_blank" rel="noreferrer"
                     className="text-sm underline text-neutral-700">
                    Ouvrir l’image
                  </a>
                )}
              </div>

              {/* APERÇU */}
              <div className="mt-3">
                <h4 className="text-sm font-medium mb-2">Aperçu du prompt</h4>
                <textarea
                  className="w-full min-h-[140px] rounded-md border border-neutral-300 px-3 py-2 text-[13px]"
                  readOnly
                  value={compiledPrompt}
                />
                {genErr && <div className="mt-2 text-xs text-red-600">Erreur: {genErr}</div>}
                {genUrl && (
                  <div className="mt-3">
                    <h4 className="text-sm font-medium mb-2">Aperçu image</h4>
                    <img src={genUrl} alt="aperçu" className="w-full rounded-lg border" />
                  </div>
                )}
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  );
}
