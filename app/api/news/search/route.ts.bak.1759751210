import { NextResponse, NextRequest } from "next/server";
import { cacheGet, cacheSet } from "@/lib/serverCache";

type Item = {
  id: string;
  title: string;
  source?: string;
  url?: string;
  link?: string;
  thumbnailUrl?: string;
  published?: string;
  topic?: string;
  _score?: number;
};

const GNEWS_KEY     = process.env.GNEWS_API_KEY || process.env.GNEWS_KEY;
const NEWSDATA_KEY  = process.env.NEWSDATA_API_KEY || process.env.NEWSDATA_KEY;

const TOPIC_KEYWORDS: Record<string,string[]> = {
  technology:["technologie","tech","numérique","innovation","IA","cloud","cyber","startup","logiciel","app"],
  science:["science","recherche","découverte","espace","physique","biologie","lab","étude"],
  world:["monde","international","UE","ONU","USA","Europe","guerre","diplomatie","conflit"],
  business:["économie","entreprise","finance","bourse","marché","acquisition","chiffre d'affaires","CA","levée de fonds"],
  sports:["sport","football","foot","rugby","tennis","basket","NBA","JO","olympique","PSG","Ligue 1","transfert"],
  health:["santé","médical","hôpital","maladie","vaccin","santé publique","soins","hôpital"],
  ai:["intelligence artificielle","IA","LLM","GPT","copilote","modèle","générative"],
  startups:["startup","levée de fonds","seed","série A","VC","incubateur","jeune pousse"],
  crypto:["crypto","bitcoin","ethereum","token","web3","wallet","NFT","minage"],
  blockchain:["blockchain","smart contract","DeFi","web3","ledger"],
  gaming:["jeu vidéo","jeux vidéo","gaming","console","Steam","PlayStation","Xbox","Nintendo","PC"],
  esports:["esport","e-sport","tournoi","league","LAN","LCS","blast","major"],
  mode:["mode","fashion","collection","défilé","luxe","couture"],
  beaute:["beauté","cosmétique","soins","make-up","maquillage"],
  food:["restaurant","gastronomie","cuisine","menu","chef","fast-food","restauration","ouverture","carte","brasserie"],
  restauration:["restaurant","chaîne de restaurants","ouverture","table","gastronomie","chef","menu","franchise"],
  immobilier:["immobilier","logement","loyer","m2","promoteur","constructeur"],
  architecture:["architecture","bâtiment","urbanisme","design"],
  art:["art","exposition","galerie","musée","vernissage","artiste"],
  culture:["culture","cinéma","film","musique","livre","série","festival"],
  mobilite:["mobilité","transport","SNCF","RATP","vélo","autopartage","covoiturage"],
  auto:["automobile","voiture","électrique","Tesla","hybride","constructeur"],
  environment:["environnement","écologie","biodiversité","COP","pollution","vert","recyclage"],
  climat:["climat","réchauffement","CO2","neutralité","canicule","empreinte"],
  economie:["économie","croissance","PIB","inflation","chômage","récession"],
  bourse:["bourse","CAC 40","actions","trading","indice","marchés"]
};

// ------ utils ------
function topicScore(text: string, topic: string): number {
  const kws = TOPIC_KEYWORDS[topic] || [];
  const t = (text || "").toLowerCase();
  let s = 0;
  for (const k of kws) if (t.includes(k.toLowerCase())) s++;
  return s;
}
function scoreItems(items: Item[], topic: string): Item[] {
  return items.map(it => {
    const txt = `${it.title || ""} - ${it.source || ""}`;
    return { ...it, _score: topicScore(txt, topic) };
  }).sort((a,b) => (b._score || 0) - (a._score || 0));
}
async function http(url: string, ms=12000) {
  const c = new AbortController();
  const t = setTimeout(()=>c.abort(), ms);
  try { return await fetch(url, { signal:c.signal, cache:"no-store" }); }
  catch { return new Response(null, { status: 599 }); }
  finally { clearTimeout(t); }
}

// ------ mappers ------
function mapGNews(js:any): Item[] {
  const arr = Array.isArray(js?.articles) ? js.articles : [];
  return arr.map((a:any, i:number) => ({
    id: a.url || String(i),
    title: a.title,
    source: a.source?.name || a.source || "GNews",
    url: a.url,
    link: a.url,
    thumbnailUrl: a.image || a.thumbnail,
    published: a.publishedAt,
  }));
}
function mapNewsData(js:any): Item[] {
  const arr = Array.isArray(js?.results) ? js.results : [];
  return arr.map((a:any, i:number) => ({
    id: a.link || String(i),
    title: a.title,
    source: a.source_id || a.source || (Array.isArray(a.creator) ? a.creator[0] : undefined),
    url: a.link,
    link: a.link,
    thumbnailUrl: a.image_url,
    published: a.pubDate,
  }));
}
function mapGoogleRSS(xml:string): Item[] {
  const out: Item[] = [];
  const items = xml.match(/<item>[\s\S]*?<\/item>/g) || [];
  for (const block of items) {
    const title = (block.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)?.[1])
               || (block.match(/<title>(.*?)<\/title>/)?.[1]) || "Sans titre";
    const link  = (block.match(/<link>(.*?)<\/link>/)?.[1]) || "";
    const pub   = (block.match(/<pubDate>(.*?)<\/pubDate>/)?.[1]) || undefined;
    out.push({
      id: link || title,
      title,
      source: "Google News",
      url: link,
      link,
      published: pub
    });
  }
  return out;
}

// ------ providers ------
async function gnewsSearch(q:string, limit:number) {
  if (!GNEWS_KEY) return [] as Item[];
  const u = new URL("https://gnews.io/api/v4/search");
  u.searchParams.set("token", GNEWS_KEY);
  u.searchParams.set("lang", "fr");
  u.searchParams.set("max", String(Math.min(limit, 50)));
  u.searchParams.set("q", q);
  const r = await http(u.toString());
  if (!("ok" in r) || !r.ok) return [];
  return mapGNews(await r.json());
}
async function newsdataSearch(q:string, limit:number) {
  if (!NEWSDATA_KEY) return [] as Item[];
  const u = new URL("https://newsdata.io/api/1/news");
  u.searchParams.set("apikey", NEWSDATA_KEY);
  u.searchParams.set("q", q);
  u.searchParams.set("language", "fr");
  u.searchParams.set("size", String(Math.min(limit, 50)));
  const r = await http(u.toString());
  if (!("ok" in r) || !r.ok) return [];
  return mapNewsData(await r.json());
}
async function googleNewsRSS(q:string, timeframe:string, limit:number) {
  const tf = timeframe === "7d" ? "7d" : timeframe === "72h" ? "3d" : timeframe === "48h" ? "2d" : "1d";
  const query = `${q} when:${tf}`;
  const rss = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=fr&gl=FR&ceid=FR:fr`;
  const r = await http(rss, 12000);
  if (!("ok" in r) || !r.ok) return [];
  const xml = await r.text();
  return mapGoogleRSS(xml).slice(0, limit);
}

// ------ handler ------
export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const cat       = (searchParams.get("cat") || searchParams.get("topic") || "technology").toLowerCase();
  const timeframe = (searchParams.get("timeframe") || "24h").toLowerCase();
  const q         = (searchParams.get("q") || "").trim();
  const limit     = Math.min(parseInt(searchParams.get("limit") || "30", 10) || 30, 50);

  const cacheKey = `news:${cat}:${timeframe}:${limit}:${q}`;
  const hit = cacheGet<{items:Item[]}>(cacheKey, 10*60*1000);
  if (hit) {
    return new NextResponse(JSON.stringify(hit), { status: 200, headers: { "content-type":"application/json","x-cache":"hit" }});
  }

  const seedQ = q || (TOPIC_KEYWORDS[cat]?.slice(0, 8).join(" OR ") || cat);

  let src = "";
  let items: Item[] = [];

  // 1) GNews
  items = await gnewsSearch(seedQ, limit);
  if (items.length) src = "gnews";

  // 2) NewsData
  if (!items.length) {
    items = await newsdataSearch(seedQ, limit);
    if (items.length) src = "newsdata";
  }

  // 3) Google News RSS
  if (!items.length) {
    items = await googleNewsRSS(seedQ, timeframe, limit);
    if (items.length) src = "googlerss";
  }

  // Scoring + fallback souple
  items = items.map(it => ({ ...it, topic: cat }));
  const scored   = scoreItems(items, cat);
  const filtered = scored.filter(it => (it._score || 0) > 0);
  const final    = (filtered.length ? filtered : scored).slice(0, limit)
                   .map(({_score, ...rest}) => rest);

  const payload = { items: final };
  cacheSet(cacheKey, payload, 10*60*1000);

  return new NextResponse(JSON.stringify(payload), {
    status: 200,
    headers: { "content-type":"application/json", "x-source": src || "none", "x-total": String(final.length) }
  });
}
