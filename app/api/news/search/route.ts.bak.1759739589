import { NextResponse, NextRequest } from "next/server";
import { cacheGet, cacheSet } from "@/lib/serverCache";

type Item = {
  id: string;
  title: string;
  source?: string;
  url?: string;
  link?: string;
  thumbnailUrl?: string;
  published?: string;
  topic?: string;        // api topic
  guessedTopic?: string; // our scoring
};

const GNEWS_KEY     = process.env.GNEWS_API_KEY || process.env.GNEWS_KEY || process.env.GNEWS_TOKEN;
const NEWSDATA_KEY  = process.env.NEWSDATA_API_KEY || process.env.NEWSDATA_KEY;

const TOPIC_KEYWORDS: Record<string, string[]> = {
  technology:  ["technologie","tech","numérique","innovation","IA","cloud","start-up","cyber"],
  science:     ["science","recherche","découverte","espace","physique","biologie"],
  world:       ["monde","international","guerre","diplomatie","ONU","UE","OTAN","pays"],
  business:    ["économie","entreprise","finance","marché","chiffre d'affaires","acquisition","bourse"],
  sports:      ["sport","football","foot","rugby","tennis","basket","JO","olympique","Ligue 1","PSG","OM"],
  health:      ["santé","médical","médecine","hôpital","maladie","vaccin","santé publique"],
  ai:          ["intelligence artificielle","IA","LLM","modèle","GPT","copilote"],
  startups:    ["startup","levée de fonds","seed","série A","incubateur","VC","venture"],
  crypto:      ["crypto","bitcoin","ethereum","token","web3","wallet","NFT"],
  blockchain:  ["blockchain","smart contract","DeFi","web3"],
  gaming:      ["jeu vidéo","jeux vidéo","gaming","console","Steam","PlayStation","Xbox","Nintendo"],
  esports:     ["esport","e-sport","tournoi","LAN","league"],
  mode:        ["mode","fashion","collection","luxe","défilé"],
  beaute:      ["beauté","cosmétique","soins","make-up"],
  food:        ["restaurant","gastronomie","cuisine","menu","chef","fast-food"],
  restauration:["restaurant","chaîne de restaurants","ouverture","table"],
  immobilier:  ["immobilier","logement","loyer","m2","constructeur"],
  architecture:["architecture","bâtiment","urbanisme","design"],
  art:         ["art","exposition","galerie","musée","vernissage"],
  culture:     ["culture","cinéma","film","musique","livre","série"],
  mobilite:    ["mobilité","transport","SNCF","RATP","vélo","autopartage"],
  auto:        ["automobile","voiture","électrique","Tesla","hybride"],
  environment: ["environnement","écologie","biodiversité","COP","pollution","vert"],
  climat:      ["climat","réchauffement","CO2","neutralité"],
  economie:    ["économie","croissance","PIB","inflation","chômage"],
  bourse:      ["bourse","CAC 40","actions","trading","indice"],
  world_fr:    ["France","Europe","monde","international"]
};

function scoreTopic(text: string, topic: string): number {
  const kws = TOPIC_KEYWORDS[topic] || [];
  const t = text.toLowerCase();
  let s = 0;
  for (const k of kws) if (t.includes(k.toLowerCase())) s++;
  return s;
}

function guessTopic(it: Item, fallback: string): string {
  const txt = [it.title, it.source].filter(Boolean).join(" - ");
  let best = { topic: fallback, score: -1 };
  for (const topic of Object.keys(TOPIC_KEYWORDS)) {
    const sc = scoreTopic(txt, topic);
    if (sc > best.score) best = { topic, score: sc };
  }
  return best.topic;
}

function toItemsFromGNews(json: any): Item[] {
  const arts = Array.isArray(json?.articles) ? json.articles : [];
  return arts.map((a: any, i: number) => ({
    id: a.url || String(i),
    title: a.title,
    source: a.source?.name || a.source,
    url: a.url,
    link: a.url,
    thumbnailUrl: a.image,
    published: a.publishedAt,
    topic: a.topic
  }));
}

function toItemsFromNewsData(json: any): Item[] {
  const arts = Array.isArray(json?.results) ? json.results : [];
  return arts.map((a: any, i: number) => ({
    id: a.link || String(i),
    title: a.title,
    source: a.source_id || a.source || a.creator?.[0],
    url: a.link,
    link: a.link,
    thumbnailUrl: a.image_url,
    published: a.pubDate,
    topic: (a.category?.[0] || "").toLowerCase()
  }));
}

async function fetchWithTimeout(url: string, init: RequestInit = {}, ms = 12000) {
  const c = new AbortController();
  const t = setTimeout(() => c.abort(), ms);
  try {
    const res = await fetch(url, { ...init, signal: c.signal, cache: "no-store" });
    return res;
  } finally {
    clearTimeout(t);
  }
}

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const cat = (searchParams.get("cat") || searchParams.get("topic") || "technology").toLowerCase();
  const q   = (searchParams.get("q") || "").trim();
  const tf  = (searchParams.get("timeframe") || "24h").toLowerCase();
  const max = Math.min(parseInt(searchParams.get("limit") || "30", 10) || 30, 50);

  // cache key & TTL
  const key = `news:${cat}:${tf}:${max}:${q}`;
  const TTL = 15 * 60 * 1000; // 15 minutes

  const cached = cacheGet<{ items: Item[] }>(key, TTL);
  if (cached) {
    return new NextResponse(JSON.stringify(cached), {
      status: 200,
      headers: { "content-type": "application/json", "x-cache": "hit" },
    });
  }

  // Build a generic query string
  const baseQ = q || (TOPIC_KEYWORDS[cat]?.slice(0, 5).join(" OR ") || cat);

  // map timeframe to "recentness" (soft; both APIs handle sort)
  const maxPerAPI = Math.min(max, 50);

  let items: Item[] = [];
  let source = "";

  // 1) Try GNews
  if (GNEWS_KEY) {
    try {
      const gUrl = new URL("https://gnews.io/api/v4/search");
      gUrl.searchParams.set("apikey", GNEWS_KEY);
      gUrl.searchParams.set("q", baseQ);
      gUrl.searchParams.set("lang", "fr");
      gUrl.searchParams.set("country", "fr");
      gUrl.searchParams.set("max", String(maxPerAPI));
      gUrl.searchParams.set("in", "title,description,content");
      const gr = await fetchWithTimeout(gUrl.toString());
      if (gr.ok) {
        const js = await gr.json();
        items = toItemsFromGNews(js);
        source = "gnews";
      }
    } catch {}
  }

  // 2) Fallback NewsData
  if (items.length === 0 && NEWSDATA_KEY) {
    try {
      const nUrl = new URL("https://newsdata.io/api/1/news");
      nUrl.searchParams.set("apikey", NEWSDATA_KEY);
      nUrl.searchParams.set("q", baseQ);
      nUrl.searchParams.set("language", "fr");
      nUrl.searchParams.set("country", "fr");
      nUrl.searchParams.set("page", "0");
      nUrl.searchParams.set("size", String(maxPerAPI));
      const nr = await fetchWithTimeout(nUrl.toString());
      if (nr.ok) {
        const js = await nr.json();
        items = toItemsFromNewsData(js);
        source = "newsdata";
      }
    } catch {}
  }

  // 3) Scoring to ensure category relevance
  const rescored = items.map(it => ({ ...it, guessedTopic: guessTopic(it, cat) }))
                        .filter(it => it.guessedTopic?.startsWith(cat) || scoreTopic(it.title || "", cat) > 0);

  const payload = { items: rescored.slice(0, max) };

  // Put in cache
  cacheSet(key, payload, TTL);

  return new NextResponse(JSON.stringify(payload), {
    status: 200,
    headers: { "content-type": "application/json", "x-cache": "miss", "x-source": source || "none" },
  });
}
