import { NextResponse, NextRequest } from "next/server";

type Item = {
  id: string;
  title: string;
  source?: string;
  url?: string;
  link?: string;
  thumbnailUrl?: string;
  published?: string;
  topic?: string;
  _score?: number;
};

const NEWSDATA_KEY =
  process.env.NEWSDATA_API_KEY ||
  process.env.NEWSDATA_KEY ||
  process.env.NEWSDATA_TOKEN ||
  "";

// Mots-clés par pilier (FR)
const TOPIC_KEYWORDS: Record<string, string[]> = {
  ai: ["intelligence artificielle","IA","LLM","GPT","OpenAI","Anthropic","DeepMind","copilote"],
  technology: ["technologie","tech","app","smartphone","Apple","Google","Microsoft","cloud","cyber"],
  business: ["économie","entreprise","startup","levée de fonds","acquisition","marché","e-commerce","SaaS"],
  finance: ["bourse","CAC 40","actions","trading","banque","taux d'intérêt","épargne"],
  crypto: ["bitcoin","ethereum","crypto","blockchain","web3","token","NFT"],
  sports: ["sport","football","foot","rugby","tennis","basket","JO","olympique","PSG","Ligue 1"],
  gaming: ["jeu vidéo","jeux vidéo","gaming","console","esport","PlayStation","Xbox","Nintendo","Steam"],
  pop: ["people","célébrité","influenceur","cinéma","film","séries","musique","festival","TikTok","YouTube"],
  food: ["restaurant","gastronomie","cuisine","chef","menu","brasserie","bistrot","fast-food","franchise"],
  lifestyle: ["voyage","tourisme","hôtel","compagnie aérienne","mode","beauté","luxe"],
  health: ["santé","bien-être","fitness","hôpital","maladie","vaccin","santé publique"],
  auto: ["automobile","voiture","électrique","Tesla","véhicule","mobilité","SNCF","RATP"],
  environment: ["environnement","écologie","climat","biodiversité","COP","pollution","canicule","inondation"],
  realestate: ["immobilier","logement","loyer","construction","architecture","urbanisme"],
  world: ["monde","international","France","gouvernement","élections","UE","USA","guerre"],
};

// Overrides ultra ciblés (si présents, on les privilégie)
const QUERY_OVERRIDE: Record<string, string> = {
  food: "(restaurant OR restaurants OR \"chaîne de restaurants\" OR \"ouverture de restaurant\" OR brasserie OR bistrot OR chef OR \"nouvelle carte\" OR franchise OR fast-food OR \"livraison de repas\" OR \"dark kitchen\")",
  sports: "(football OR foot OR PSG OR OM OR \"Ligue 1\" OR JO OR olympique OR rugby OR tennis OR basket)",
  gaming: "(gaming OR \"jeu vidéo\" OR \"jeux vidéo\" OR esport OR PlayStation OR Xbox OR Nintendo OR Steam)",
  pop: "(célébrité OR people OR influenceur OR buzz OR cinéma OR film OR séries OR musique OR TikTok OR YouTube)",
  auto: "(Tesla OR \"voiture électrique\" OR EV OR batterie OR \"véhicule autonome\" OR mobilité)",
};

function buildQuery(cat: string, q?: string | null) {
  return q?.trim() ||
    QUERY_OVERRIDE[cat] ||
    (TOPIC_KEYWORDS[cat]?.slice(0, 8).join(" OR ") || cat);
}

function parseTimeframe(tf: string | null): number {
  const s = (tf || "24h").trim();
  if (/^\d+\s*h$/.test(s)) return parseInt(s) * 60 * 60 * 1000;
  if (/^\d+\s*d$/.test(s)) return parseInt(s) * 24 * 60 * 60 * 1000;
  if (s === "48h") return 48 * 60 * 60 * 1000;
  if (s === "72h") return 72 * 60 * 60 * 1000;
  if (s === "7d") return 7 * 24 * 60 * 60 * 1000;
  return 24 * 60 * 60 * 1000;
}

async function http(url: string, ms = 12000): Promise<Response | null> {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ms);
  try {
    const r = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    return r;
  } catch {
    return null;
  } finally {
    clearTimeout(t);
  }
}

function mapNewsData(js: any): Item[] {
  const arr = Array.isArray(js?.results) ? js.results : [];
  return arr.map((a: any, i: number) => ({
    id: a.link || String(i),
    title: a.title,
    source: a.source_id || a.source || (Array.isArray(a.creator) ? a.creator[0] : undefined),
    url: a.link,
    link: a.link,
    thumbnailUrl: a.image_url,
    published: a.pubDate,
  }));
}

async function newsdataSearch(query: string, limit: number, country?: string) {
  if (!NEWSDATA_KEY) return [] as Item[];
  const u = new URL("https://newsdata.io/api/1/news");
  u.searchParams.set("apikey", NEWSDATA_KEY);
  u.searchParams.set("q", query);
  u.searchParams.set("language", "fr");
  if (country) u.searchParams.set("country", country);
  const r = await http(u.toString());
  if (!r || !r.ok) return [];
  const js = await r.json().catch(() => ({}));
  return mapNewsData(js).slice(0, limit);
}

function scoreItems(items: Item[], cat: string): Item[] {
  const kws = TOPIC_KEYWORDS[cat] || [];
  return items
    .map(it => {
      const txt = `${it.title || ""} ${it.source || ""}`.toLowerCase();
      const s = kws.reduce((acc, k) => acc + (txt.includes(k.toLowerCase()) ? 1 : 0), 0);
      return { ...it, _score: s };
    })
    .sort((a, b) => (b._score || 0) - (a._score || 0));
}

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const cat = (searchParams.get("cat") || searchParams.get("topic") || "technology").toLowerCase();
    const q   = (searchParams.get("q") || "").trim();
    const limit = Math.min(parseInt(searchParams.get("limit") || "30", 10) || 30, 50);
    const timeframe = searchParams.get("timeframe") || "24h";
    const maxAgeMs = parseTimeframe(timeframe);

    const seedQ = buildQuery(cat, q);

    let src = "";
    let items: Item[] = [];

    // FR prioritaire → fallback global
    items = await newsdataSearch(seedQ, limit, "fr");
    if (items.length) src = "newsdata:fr";
    if (!items.length) {
      items = await newsdataSearch(seedQ, limit);
      if (items.length) src = "newsdata";
    }

    // Filtre période
    const cutoff = Date.now() - maxAgeMs;
    items = items.filter(it => {
      if (!it.published) return true;
      const t = Date.parse(it.published);
      return isFinite(t) ? t >= cutoff : true;
    });

    // Tri par date décroissante
    items.sort((a, b) => {
      const ta = Date.parse(a.published || "") || 0;
      const tb = Date.parse(b.published || "") || 0;
      return tb - ta;
    });

    // Score par pertinence de catégorie
    const scored = scoreItems(items, cat);
    const final = (scored.length ? scored : items)
      .slice(0, limit)
      .map(({ _score, ...rest }) => ({ ...rest, topic: cat }));

    return new NextResponse(JSON.stringify({ items: final }), {
      status: 200,
      headers: {
        "content-type": "application/json",
        "x-source": src || "none",
        "x-total": String(final.length),
      },
    });
  } catch (e) {
    return new NextResponse(JSON.stringify({ items: [] }), {
      status: 200,
      headers: { "content-type": "application/json" },
    });
  }
}
