export const runtime = "nodejs";

export async function POST(req: Request) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    return new Response("Missing OPENAI_API_KEY in env", { status: 400 });
  }
  try {
    const body = await req.json();
    const prompt = String(body?.prompt || "Create a modern social image.");
    // On peut injecter quelques infos de l'actu si pr√©sentes
    const sel = body?.selected;
    const extra = sel?.title ? `\n\nNews context: ${sel.title} (${sel?.source||""})` : "";
    const finalPrompt = prompt + extra;

    const r = await fetch("https://api.openai.com/v1/images", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-image-1",
        prompt: finalPrompt,
        size: "1024x1024",
        response_format: "b64_json"
      })
    });

    if (!r.ok) {
      const t = await r.text();
      return new Response(`Upstream error: ${t}`, { status: 502 });
    }
    const j = await r.json();
    const b64 = j?.data?.[0]?.b64_json;
    if (!b64) return new Response("No image from upstream", { status: 502 });
    const dataUrl = `data:image/png;base64,${b64}`;
    return Response.json({ imageDataUrl: dataUrl });
  } catch (e: any) {
    return new Response(String(e?.message || e), { status: 500 });
  }
}
