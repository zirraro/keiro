import { NextResponse } from 'next/server';
import { Agent } from 'undici';

export const runtime = 'nodejs';

function resolveBase() {
  return (process.env.SEEDREAM_BASE_URL || 'https://api.seedream.ai').replace(/\/+$/, '');
}
function resolveSNI(hostname: string) {
  const sni = (process.env.SEEDREAM_SNI || '').trim();
  if (!sni) return hostname;
  if (sni.toLowerCase() === 'disable') return undefined as any;
  return sni;
}
function getDispatcher() {
  const base = resolveBase();
  const u = new URL(base);
  const servername = resolveSNI(u.hostname);
  return new Agent({
    connect: {
      servername,
      timeout: 30_000
    }
  });
}

export async function POST(req: Request) {
  const key = (process.env.SEEDREAM_API_KEY || '').trim();
  if (!key) return NextResponse.json({ error: 'missing_key' }, { status: 500 });

  let body: any = {};
  try { body = await req.json(); } catch { /* noop */ }
  const prompt = (body?.prompt || '').toString().trim();
  const size   = (body?.size || '512x512').toString();

  if (!prompt) return NextResponse.json({ error: 'missing_prompt' }, { status: 400 });

  const base = resolveBase();
  const dispatcher = getDispatcher();

  try {
    const r = await fetch(`${base}/v1/images/generate`, {
      method: 'POST',
      headers: {
        'authorization': `Bearer ${key}`,
        'content-type': 'application/json',
        'accept': 'application/json'
      },
      body: JSON.stringify({ prompt, size }),
      // @ts-ignore â€” Next 15/undici: on peut passer un dispatcher custom
      dispatcher
    });

    const txt = await r.text();
    let data: any;
    try { data = JSON.parse(txt); } catch { data = { raw: txt }; }

    if (!r.ok) {
      return NextResponse.json({ error: 'upstream_error', status: r.status, data }, { status: 502 });
    }
    return NextResponse.json(data);
  } catch (e: any) {
    return NextResponse.json({ error: 'network_error', message: String(e?.stack || e) }, { status: 500 });
  }
}

export async function GET() {
  return NextResponse.json({ ok: true });
}
